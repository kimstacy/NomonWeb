<html>
<link rel="icon"
      type="image/png"
      href="icon.png">
<head>
   <title>Nomon Keyboard Login</title>
   <style>
    body{
       font-family: "Helvetica", Gadget, sans-serif;
    }
     #container{
       text-align: center;
     }
    #container table{
      margin: 0 auto;
      text-align: left;
    }
    .btn {
      background-color: #0056ff;
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    input[type='text'] {
      width: 100%;
      padding: 12px 20px;
      margin: 8px 0;
      display: inline-block;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
  .success, .error{
    width: 20%;
    border: 1px solid;
    margin: 10px 0px;
    padding:15px 10px 15px 50px;
    background-repeat: no-repeat;
    background-position: 10px center;
    display: inline-block;
  }
.success {
  color: #4F8A10;
  background-color: #DFF2BF;
}
.error {
  color: #D8000C;
  background-color: #FFBABA;
  }
</style>
</head>
<body>

    <div id = "container" >
    <h1>Welcome to the Keyboard Study!</h1>
    <p id="info_text"><strong>If you are a returning user, please enter your user ID below.<br>
    Otherwise, leave the field blank and press "Enter".</strong></p>
    <div id="message"></div>
    <form name='form1'>
        <table align = "">
        <tr><td></td></tr>
            <tr>
            <td>
                <label>User ID:</label>
            </td>

            <td>
                <input type='text' placeholder='User ID' name='user_id' id= 'user_id' required ><br />
            </td>
            <td>
                <input class='btn' type="button" id = "send_button" value = "Enter" formaction="html/keyboard.html"/>
            </td>
            </tr>
        </table>
    </form>
    </div>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script type="text/javascript">
        var logged_in = false;
        function create_user(user_id) {
            $.ajax({
                method: "POST",
                url: "../php/create_user.php",
                data: {"user_id": user_id}
            }).done(function (data) {
                console.log(data);
            });
        }

        function handle_partial_sessions(nomon_sessions, rowcol_sessions, first_software) {
            var session_num = Math.min(nomon_sessions, rowcol_sessions);
            var partial_session;
            var next_software;
            var cur_info_text = document.getElementById("info_text").textContent;

            if (nomon_sessions < rowcol_sessions){
                document.getElementById("info_text").innerHTML =
                        `<strong>${cur_info_text} <br> You have not completed session ${session_num}. Click to continue.</strong>`;

                next_software = "A";
                partial_session = true;

            } else if (rowcol_sessions < nomon_sessions){

                document.getElementById("info_text").innerHTML =
                        `<strong>${cur_info_text} <br> You have not completed session ${session_num}. Click to continue.</strong>`;

                next_software = "B";
                partial_session = true;

            } else {

                document.getElementById("info_text").innerHTML =
                        `<strong>${cur_info_text} <br> You have completed ${session_num} sessions. Click to launch the keyboard software.</strong>`;

                if (session_num % 2){
                    if (first_software === "nomon") {
                        first_software = "rowcol";
                    }else{
                        first_software = "nomon";
                    }
                }
                if (first_software === "nomon"){
                    next_software = "A";
                } else {
                    next_software = "B";
                }
                partial_session = false;
            }

            return [session_num, next_software, partial_session];
        }

        function init_study(user_id) {
            $.ajax({
                method: "POST",
                url: "../php/init_study.php",
                data: {"user_id": user_id}
            }).done(function (data) {
                var result = $.parseJSON(data);
                console.log(result);
                var user_id = result[0].id;
                var first_software = result[0].first_software;

                var next_session_results = handle_partial_sessions(parseInt(result[0].nomon_sessions), parseInt(result[0].rowcol_sessions), first_software);
                var session_num = next_session_results[0];
                var next_software = next_session_results[1];
                var partial_session = next_session_results[2];

                var first_load;
                if (session_num == 0){
                    first_load = "true";
                } else {
                    first_load = "false";
                }

                var emoji;
                if (session_num == 9){
                    emoji="true";
                } else {
                    emoji="true";
                }


                launch_software(user_id, next_software, partial_session, first_load, emoji);

            });

        }

        function launch_software(user_id, next_software, partial_session, first_load, emoji){

            document.getElementById("send_button").value = "Launch Software";

            document.getElementById("send_button").onclick = function(){
                keyboard_url = "html/webcam_setup.html".concat('?user_id=', user_id.toString(), '&first_load=', first_load,
                    '&partial_session=', partial_session.toString(), '&software=', next_software, '&emoji=', emoji, '&forward=true');
                window.open(keyboard_url,'_self');
            };
        }

        function send_login() {
            var requested_user_id = $("#user_id").val();
            $.ajax({
                method: "GET",
                url: "../php/send_login.php",
                data: {"user_id": requested_user_id}
            }).done(function (data) {
                var result = $.parseJSON(data);
                console.log(result);
                var user_id;
                var click_dist;
                if (result.length > 0) {
                    result = result[0];
                }
                if ("MAX(id)" in result) {  // Create new user
                    console.log("requested_id:", requested_user_id);
                    if (!Number.isInteger(parseInt(requested_user_id))) {
                        user_id = parseInt(result["MAX(id)"]) + 7;
                        if (Number.isNaN(user_id)){
                            user_id = 0;
                        }
                        console.log("given_id:", user_id);
                        document.getElementById("info_text").innerHTML =
                            `<strong>Your ID will be: ${user_id}. Press "Create User".</strong>`;
                        document.getElementById("send_button").value = "Create User";
                        document.getElementById("user_id").style.display = "none";
                        create_user(user_id);
                        document.getElementById("info_text").innerHTML =
                        `<strong>Created user with ID ${user_id}!</strong>`;
                        init_study(user_id);
                    }
                } else if ("id" in result) {  // Load previous user
                    user_id = requested_user_id;
                    click_dist = result.click_dist;
                    if (click_dist === null) {
                        document.getElementById("info_text").innerHTML =
                            `<strong>Loading User ${user_id}... No user preferences were found.</strong>`;
                    } else {
                        document.getElementById("info_text").innerHTML =
                            `<strong>Loading User ${user_id}... User preferences loaded!</strong>`;
                    }
                    console.log("given_id:", user_id);
                    init_study(user_id);
                }
                else {  //  User not found
                    document.getElementById("info_text").innerHTML =
                        `<strong>We could not find a user with ID ${requested_user_id}. Please try again.</strong>`;
                    document.getElementById("send_button").value = "Enter";
                }
            });
        }
        document.getElementById("send_button").onclick = send_login;
        // $("#send_button").on('click', send_login());

        // });
    </script>

</body>
</html>