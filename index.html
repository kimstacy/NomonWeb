<html>
<head>
   <title>Nomon Keyboard Login</title>
   <style>
    body{
       font-family: "Helvetica", Gadget, sans-serif;
    }
     #container{
       text-align: center;
     }
    #container table{
      margin: 0 auto;
      text-align: left;
    }
    .btn {
      background-color: #0056ff;
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    input[type='text'] {
      width: 100%;
      padding: 12px 20px;
      margin: 8px 0;
      display: inline-block;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
  .success, .error{
    width: 20%;
    border: 1px solid;
    margin: 10px 0px;
    padding:15px 10px 15px 50px;
    background-repeat: no-repeat;
    background-position: 10px center;
    display: inline-block;
  }
.success {
  color: #4F8A10;
  background-color: #DFF2BF;
}
.error {
  color: #D8000C;
  background-color: #FFBABA;
  }
</style>
</head>
<body>
    <div id = "container" >
    <h1>Welcome to the Nomon Keybaord!</h1>
    <p id="info_text"><strong>If you are a returning user, please enter your user ID below.<br>
    Otherwise, leave the field blank and press "Enter".</strong></p>
    <div id="message"></div>
    <form name='form1'>
        <table align = "">
        <tr><td></td></tr>
            <tr>
            <td>
                <label>User ID:</label>
            </td>

            <td>
                <input type='text' placeholder='User ID' name='user_id' id= 'user_id' required ><br />
            </td>
            <td>
                <input class='btn' type="button" id = "send_button" value = "Enter" formaction="html/keyboard.html"/>
            </td>
            </tr>
        </table>
    </form>
    </div>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script type="text/javascript">
        var logged_in = false;
        function create_user(user_id) {
            $.ajax({
                method: "POST",
                url: "create_user.php",
                data: {"user_id": user_id}
            }).done(function (data) {
                console.log(data);
                document.getElementById("send_button").value = "Launch Nomon";
                document.getElementById("info_text").innerHTML =
                            `<strong>Created user with ID ${user_id}! Click to launch Nomon.</strong>`;
                document.getElementById("send_button").onclick = function(){
                    var keyboard_url = "html/keyboard.html";
                    keyboard_url = keyboard_url.concat('?user_id=', user_id.toString(), '&first_load=true');
                    window.open(keyboard_url,'_self');
                };
            });
        }

        function send_login() {
            var requested_user_id = $("#user_id").val();
            $.ajax({
                method: "GET",
                url: "send_login.php",
                data: {"user_id": requested_user_id}
            }).done(function (data) {
                var result = $.parseJSON(data);
                console.log(result);
                var user_id;
                var click_dist;
                if (result.length > 0) {
                    result = result[0];
                }
                if ("MAX(id)" in result) {
                    console.log(requested_user_id);
                    if (!Number.isInteger(parseInt(requested_user_id))) {
                        user_id = parseInt(result["MAX(id)"]) + 7;
                        document.getElementById("info_text").innerHTML =
                            `<strong>Your ID will be: ${user_id}. Press "Create User".</strong>`;
                        document.getElementById("send_button").value = "Create User";
                        document.getElementById("user_id").style.display = "none";
                        document.getElementById("send_button").onclick = function() {
                            create_user(user_id);
                        };

                    }
                } else if ("id" in result) {
                    user_id = requested_user_id;
                    click_dist = result["click_dist"];
                    if (click_dist === null) {
                        document.getElementById("info_text").innerHTML =
                            `<strong>Loading User ${user_id}... No click distribution was found.</strong>`;
                    } else {
                        document.getElementById("info_text").innerHTML =
                            `<strong>Loading User ${user_id}... Click distribution loaded!</strong>`;
                    }

                    document.getElementById("send_button").value = "Launch Nomon";
                    document.getElementById("user_id").style.display = "none";
                    document.getElementById("send_button").onclick = function(){
                        var keyboard_url = "html/keyboard.html";
                        keyboard_url = keyboard_url.concat('?user_id=', user_id.toString(), '&first_load=false');
                        window.open(keyboard_url,'_self');
                    };
                }
                else {
                    document.getElementById("info_text").innerHTML =
                        `<strong>We could not find a user with ID ${requested_user_id}. Please try again.</strong>`;
                    document.getElementById("send_button").value = "Enter";
                }
            });
        }
        document.getElementById("send_button").onclick = send_login;
        // $("#send_button").on('click', send_login());

        // });
    </script>

</body>
</html>